<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyTraining Ultimate</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4F46E5; --primary-light: #EEF2FF;
            --secondary: #10B981; --secondary-light: #D1FAE5;
            --danger: #EF4444; --accent: #F59E0B;
            --dark: #1F2937; --gray: #6B7280;
            --bg: #F3F4F6; --card: #FFFFFF;
            --radius: 16px; --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; color: var(--dark); }
        
        /* HEADER */
        header { background: linear-gradient(135deg, var(--primary) 0%, #4338ca 100%); color: white; padding: 30px 20px 40px 20px; border-radius: 0 0 24px 24px; box-shadow: var(--shadow); margin-bottom: -20px; }
        h1 { margin: 0; font-size: 1.5em; font-weight: 800; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 0 15px; }
        .view { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.02); }
        h2, h3 { margin-top: 0; font-weight: 700; color: var(--dark); font-size: 1.1em; margin-bottom: 15px; }

        input, select { width: 100%; padding: 14px; margin: 8px 0; border: 2px solid #E5E7EB; border-radius: 12px; box-sizing: border-box; font-size: 16px; background: #F9FAFB; }
        input:focus { outline: none; border-color: var(--primary); background: white; }

        button { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; transition: 0.1s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.97); }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--secondary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); box-shadow: none; }
        
        .fab { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); width: auto; padding: 12px 30px; border-radius: 30px; background: var(--dark); color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 90; display: flex; gap: 10px; align-items: center; }

        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; padding: 10px 0 25px 0; z-index: 100; }
        .nav-item { cursor: pointer; color: #9CA3AF; text-align: center; flex: 1; font-size: 0.7em; font-weight: 600; }
        .nav-icon { font-size: 1.5em; display: block; }
        .nav-item.active { color: var(--primary); }

        /* HEATMAP Style */
        .heatmap-container { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; }
        .heat-day { width: 12px; height: 12px; border-radius: 3px; background-color: #E5E7EB; }
        .heat-day.l1 { background-color: #A7F3D0; } /* Peu */
        .heat-day.l2 { background-color: #34D399; } /* Moyen */
        .heat-day.l3 { background-color: #059669; } /* Beaucoup */

        /* PR WALL Style */
        .pr-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #F3F4F6; }
        .pr-badge { background: #FEF3C7; color: #D97706; font-weight: bold; font-size: 0.8em; padding: 4px 8px; border-radius: 6px; }
        .pr-val { font-weight: 800; font-size: 1.1em; color: var(--dark); }

        /* CHART TOGGLES */
        .chart-toggles { display: flex; gap: 5px; margin-bottom: 10px; justify-content: center; }
        .toggle-btn { padding: 6px 12px; font-size: 0.8em; border-radius: 20px; border: 1px solid #E5E7EB; background: white; cursor: pointer; color: var(--gray); box-shadow: none; margin:0; width: auto;}
        .toggle-btn.active { background: var(--dark); color: white; border-color: var(--dark); }

        /* --- Autres Styles V10 --- */
        .pill-selector { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .pill { flex: 1; padding: 10px; text-align: center; border: 1px solid #E5E7EB; border-radius: 10px; font-size: 0.85em; font-weight: 600; color: var(--gray); background: white; white-space: nowrap; cursor: pointer; }
        .pill.active { background: var(--primary-light); color: var(--primary); border-color: var(--primary); }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #F3F4F6; }
        .weight-card { display: flex; justify-content: space-between; align-items: center; background: white; border-radius: var(--radius); padding: 15px 20px; margin-top: -30px; margin-bottom: 20px; position: relative; z-index: 10; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .timer-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--card); z-index: 200; display:none; flex-direction:column; align-items:center; justify-content:center; }
        .timer-big { font-size: 5em; font-weight: 800; color: var(--dark); font-variant-numeric: tabular-nums; }
        .chart-wrapper { position: relative; height: 250px; width: 100%; }
    </style>
</head>
<body>

    <header>
        <h1>MyTraining Ultimate</h1>
        <div style="opacity:0.8; font-size:0.9em;" id="headerDate">Chargement...</div>
    </header>

    <div class="container">

        <div id="view-history" class="view active">
            <div class="weight-card">
                <div>
                    <div style="font-weight:bold;">Mon Poids</div>
                    <div style="font-size:0.8em; color:var(--gray);">N√©cessaire pour le 1RM & Ratio</div>
                </div>
                <input type="number" id="currentBodyWeight" style="width: 80px; text-align:center; margin:0; border:none; background:#F3F4F6; font-weight:bold; color:var(--primary);" placeholder="kg" onchange="saveUserWeight()">
            </div>

            <div class="card">
                <h3>üî• Consistance (3 mois)</h3>
                <div class="heatmap-container" id="heatmap"></div>
            </div>

            <div class="card">
                <h3>Historique R√©cent</h3>
                <div id="historyList"></div>
            </div>

            <button class="fab" onclick="startNewSession()"><span>+</span> Nouvelle S√©ance</button>
        </div>

        <div id="view-workout" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; margin-bottom:10px;">
                <h2>S√©ance en cours</h2>
                <button class="btn-danger" style="width:auto; padding:8px 12px; margin:0;" onclick="cancelSession()">Annuler</button>
            </div>

            <div class="card">
                <h3>Exercice</h3>
                <input type="text" id="exoName" list="exoSuggestions" placeholder="Nom..." onchange="autoFillCategory()">
                <datalist id="exoSuggestions"></datalist>

                <div class="pill-selector">
                    <div class="pill active" onclick="setCategory(this, 'Push')">Pouss√©e</div>
                    <div class="pill" onclick="setCategory(this, 'Pull')">Tirage</div>
                    <div class="pill" onclick="setCategory(this, 'Legs')">Jambes</div>
                    <div class="pill" onclick="setCategory(this, 'Core')">Core</div>
                </div>
                <div class="pill-selector">
                    <div class="pill active" id="btn-std" onclick="setMode('standard')">Fonte</div>
                    <div class="pill" id="btn-bw" onclick="setMode('bodyweight')">PDC</div>
                    <div class="pill" id="btn-time" onclick="setMode('time')">Chrono</div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <div style="flex:1">
                        <label id="labelVal1" style="font-size:0.8em; font-weight:bold;">Poids</label>
                        <input type="number" id="inputVal1" inputmode="decimal">
                    </div>
                    <div style="flex:1">
                        <label id="labelVal2" style="font-size:0.8em; font-weight:bold;">Reps</label>
                        <input type="number" id="inputVal2" inputmode="numeric">
                    </div>
                </div>
                <button class="btn-outline" onclick="addSetToBuffer()">+ Ajouter S√©rie</button>
                <div id="bufferList" style="margin-top:15px; background:var(--bg); padding:10px; border-radius:8px; font-size:0.9em;">...</div>
                <button class="btn-primary" onclick="confirmExercise()">Valider</button>
            </div>

            <h3 style="margin-top:20px;">R√©sum√©</h3>
            <div id="currentSessionList"></div>
            <button class="btn-success" onclick="finishSession()" style="margin-bottom:30px;">Terminer</button>
        </div>

        <div id="view-stats" class="view">
            
            <div class="card" style="margin-top:20px;">
                <h3>üèÜ Mur des Records (1RM Est.)</h3>
                <div id="prWallList"></div>
                <p style="font-size:0.75em; color:var(--gray); margin-top:10px;">*Bas√© sur le calcul Epley (Poids + Lest + PDC)</p>
            </div>

            <div class="card">
                <h3>üìà Analyse D√©taill√©e</h3>
                <select id="statExoSelect" onchange="updateLineChart()"></select>
                
                <div class="chart-toggles">
                    <button class="toggle-btn active" onclick="setChartMetric('raw', this)">Perf Brute</button>
                    <button class="toggle-btn" onclick="setChartMetric('1rm', this)">1RM Est.</button>
                    <button class="toggle-btn" onclick="setChartMetric('ratio', this)">Ratio Poids</button>
                </div>

                <div class="chart-wrapper">
                    <canvas id="progChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üï∏Ô∏è √âquilibre</h3>
                <div class="chart-wrapper">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
        </div>

        <div id="view-emom" class="view">
            <div style="margin-top:20px; display:flex; justify-content:space-between;">
                <h2>Cycles EMOM</h2>
                <button class="btn-primary" onclick="toggleCreateForm()" style="width:auto; padding:8px 15px;">+ Nouveau</button>
            </div>
            
            <div id="emom-create" class="card" style="display:none; border:2px solid var(--primary);">
                <input type="text" id="newCycleExo" placeholder="Exercice">
                <input type="text" id="newCycleLoad" placeholder="Assistance">
                <input type="number" id="newCycleReps" placeholder="Reps Base">
                <div style="display:flex; gap:10px;">
                    <button class="btn-success" onclick="createEmomCycle()">OK</button>
                    <button class="btn-outline" onclick="toggleCreateForm()">Annuler</button>
                </div>
            </div>
            <div id="activeCyclesList"></div>
            <div class="card" style="margin-top:20px;">
                <h3 onclick="toggleArchives()">Historique <span>‚ñº</span></h3>
                <div id="emom-archives" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:10px;"></div>
            </div>
        </div>
    </div>

    <div id="timer-overlay" class="timer-overlay">
        <h2 id="timerExoTitle">...</h2>
        <div id="timerLoadInfo" style="color:var(--accent); font-weight:bold; margin-bottom:20px;">...</div>
        <div class="timer-big" id="timerBigDisplay">00:00</div>
        <div style="font-size:1.5em; color:var(--gray); margin-bottom:40px;" id="timerRoundDisplay">Round 1/10</div>
        <div style="width:80%; max-width:300px;">
            <button class="btn-success" onclick="startTimerEngine()" id="btnGo">GO</button>
            <button class="btn-danger" onclick="stopTimerEngine()" id="btnStop" style="display:none;">STOP</button>
            <button class="btn-outline" onclick="closeTimer()" id="btnCloseTimer" style="margin-top:15px;">Fermer</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchView('view-history', this)"><span class="nav-icon">üìÖ</span>Journal</div>
        <div class="nav-item" onclick="switchView('view-stats', this)"><span class="nav-icon">üìä</span>Stats</div>
        <div class="nav-item" onclick="switchView('view-emom', this)"><span class="nav-icon">‚è±Ô∏è</span>Cycles</div>
    </div>

    <script>
        // CONFIG
        const DB_KEY = 'muscu_data_final';
        const CONFIG_KEY = 'muscu_config_final';
        const EMOM_KEY = 'muscu_emom_final';
        const LIB_KEY = 'muscu_lib_final';

        // STATE
        let currentSession = null;
        let bufferSets = [];
        let currentMode = 'standard';
        let currentCategory = 'Push';
        let chartMetric = 'raw'; // raw | 1rm | ratio
        
        let lineChart, radarChart = null;
        let activeCycles=[], runningCycleId=null, runningWeekIndex=0, timerInterval=null, timerSeconds=0, currentRound=1, totalRounds=10, audioCtx=null;

        window.onload = function() {
            document.getElementById('headerDate').innerText = new Date().toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'});
            const conf = JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}');
            if(conf.weight) document.getElementById('currentBodyWeight').value = conf.weight;
            
            updateDatalist();
            renderHistory();
            renderHeatmap(); // New
            renderEmomView();
        }

        function switchView(vid, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(vid).classList.add('active');
            if(el) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); }
            
            if(vid === 'view-history') { renderHistory(); renderHeatmap(); }
            if(vid === 'view-stats') { initStats(); initRadar(); renderPRs(); }
            if(vid === 'view-emom') renderEmomView();
        }

        // --- NEW FEATURES ---

        // 1. HEATMAP
        function renderHeatmap() {
            const db = JSON.parse(localStorage.getItem(DB_KEY)||'[]');
            const container = document.getElementById('heatmap');
            container.innerHTML = '';
            
            // Map dates to counts
            const counts = {};
            db.forEach(s => {
                const d = s.date.split('T')[0];
                counts[d] = (counts[d] || 0) + 1;
            });

            // Generate last 90 days
            for (let i = 89; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const iso = d.toISOString().split('T')[0];
                const count = counts[iso] || 0;
                
                const div = document.createElement('div');
                div.className = 'heat-day';
                div.title = `${iso}: ${count} s√©ances`;
                if(count >= 1) div.classList.add('l1');
                if(count >= 2) div.classList.add('l2');
                container.appendChild(div);
            }
        }

        // 2. HELPER CALCUL 1RM (Epley)
        function calculate1RM(weight, reps, bodyweight, mode) {
            if(mode === 'time') return 0; // Pas de 1RM sur le temps
            
            let load = 0;
            if(mode === 'standard') load = weight;
            if(mode === 'bodyweight') load = bodyweight + weight; // Weight = Lest

            if(reps === 1) return load;
            return load * (1 + reps/30);
        }

        // 3. PR WALL
        function renderPRs() {
            const db = JSON.parse(localStorage.getItem(DB_KEY)||'[]');
            const list = document.getElementById('prWallList');
            list.innerHTML = '';

            const bests = {}; // { "Traction": { val: 120, date: "..." } }

            db.forEach(s => {
                s.exercises.forEach(e => {
                    if(e.type === 'time') return;
                    e.sets.forEach(set => {
                        const w = set.val1 || 0;
                        const r = set.val2 || 0;
                        const rm = calculate1RM(w, r, s.userWeight, e.type);
                        
                        if(!bests[e.name] || rm > bests[e.name].val) {
                            bests[e.name] = { val: rm, date: s.date };
                        }
                    });
                });
            });

            // Trier et afficher
            Object.keys(bests).sort().forEach(exo => {
                const item = bests[exo];
                const d = new Date(item.date).toLocaleDateString('fr-FR');
                list.innerHTML += `
                    <div class="pr-item">
                        <div>
                            <div>${exo}</div>
                            <div style="font-size:0.75em; color:var(--gray);">${d}</div>
                        </div>
                        <div class="pr-val">${Math.round(item.val)} kg</div>
                    </div>
                `;
            });
            if(Object.keys(bests).length === 0) list.innerHTML = '<div style="color:var(--gray); text-align:center;">Pas encore de records.</div>';
        }

        // 4. CHART METRIC SWITCHER
        function setChartMetric(m, btn) {
            chartMetric = m;
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateLineChart();
        }

        // --- CORE FUNCTIONS (Updated for V11) ---
        function saveUserWeight() {
            const w = document.getElementById('currentBodyWeight').value;
            const c = JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}');
            c.weight = w; localStorage.setItem(CONFIG_KEY, JSON.stringify(c));
        }

        function updateLineChart() {
            const name = document.getElementById('statExoSelect').value;
            const db = JSON.parse(localStorage.getItem(DB_KEY)||'[]');
            db.sort((a,b)=>new Date(a.date)-new Date(b.date));

            const labels = [];
            const data = [];

            db.forEach(s => {
                const match = s.exercises.find(e => e.name === name);
                if(match) {
                    labels.push(new Date(s.date).toLocaleDateString('fr-FR', {day:'numeric', month:'short'}));
                    
                    // Trouver la meilleure s√©rie de la s√©ance
                    let maxVal = 0;
                    match.sets.forEach(set => {
                        let val = 0;
                        if(match.type === 'time') {
                            val = set.val2; // Temps brut
                        } else {
                            // Calcul selon la m√©trique choisie
                            const w = set.val1 || 0;
                            const r = set.val2 || 0;
                            
                            if(chartMetric === 'raw') {
                                // Juste le poids ajout√©
                                val = (match.type === 'bodyweight') ? w : w; 
                            } else if (chartMetric === '1rm') {
                                val = calculate1RM(w, r, s.userWeight, match.type);
                            } else if (chartMetric === 'ratio') {
                                const rm = calculate1RM(w, r, s.userWeight, match.type);
                                val = (s.userWeight > 0) ? (rm / s.userWeight) : 0;
                            }
                        }
                        if(val > maxVal) maxVal = val;
                    });
                    data.push(maxVal);
                }
            });

            const ctx = document.getElementById('progChart').getContext('2d');
            if(lineChart) lineChart.destroy();

            let label = 'Performance';
            if(chartMetric === '1rm') label = '1RM Estim√© (kg)';
            if(chartMetric === 'ratio') label = 'Ratio (x Poids Corps)';
            if(chartMetric === 'raw') label = 'Charge (kg) ou Temps (s)';

            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true, tension: 0.3
                    }]
                },
                options: { maintainAspectRatio: false, responsive: true }
            });
        }

        // --- (EXISTING LOGIC) ---
        function getLibrary(){ return JSON.parse(localStorage.getItem(LIB_KEY)||'{}'); }
        function saveToLibrary(n,c){ const l=getLibrary(); l[n]=c; localStorage.setItem(LIB_KEY,JSON.stringify(l)); updateDatalist(); }
        function updateDatalist(){ const l=getLibrary(); const d=document.getElementById('exoSuggestions'); d.innerHTML=''; Object.keys(l).sort().forEach(n=>{ const o=document.createElement('option'); o.value=n; d.appendChild(o); }); }
        function autoFillCategory(){ const n=document.getElementById('exoName').value; const l=getLibrary(); if(l[n]) setCategory(null, l[n]); }
        function setCategory(el,c){ currentCategory=c; if(el){ document.querySelectorAll('.pill-selector:first-of-type .pill').forEach(p=>p.classList.remove('active')); el.classList.add('active'); } else { document.querySelectorAll('.pill-selector:first-of-type .pill').forEach(p => { if(p.innerText === (c==='Push'?'Pouss√©e':c==='Pull'?'Tirage':c==='Legs'?'Jambes':'Core')) p.click(); }); } }
        function setMode(m){ currentMode=m; document.querySelectorAll('#btn-std, #btn-bw, #btn-time').forEach(b=>b.classList.remove('active')); if(m==='standard')document.getElementById('btn-std').classList.add('active'); if(m==='bodyweight')document.getElementById('btn-bw').classList.add('active'); if(m==='time')document.getElementById('btn-time').classList.add('active'); const l1=document.getElementById('labelVal1'); const i1=document.getElementById('inputVal1'); const l2=document.getElementById('labelVal2'); const i2=document.getElementById('inputVal2'); if(m==='standard'){l1.innerText="Poids"; i1.placeholder="60"; l2.innerText="Reps";} else if(m==='bodyweight'){l1.innerText="Lest"; i1.placeholder="0"; l2.innerText="Reps";} else {l1.innerText="Lest"; i1.placeholder="0"; l2.innerText="Secs";} }
        function startNewSession(){ const w=document.getElementById('currentBodyWeight').value; if(!w){alert("Poids requis !");return;} currentSession={date:new Date().toISOString(), userWeight:parseFloat(w), exercises:[]}; bufferSets=[]; document.getElementById('exoName').value=''; document.getElementById('bufferList').innerHTML='...'; document.getElementById('currentSessionList').innerHTML=''; switchView('view-workout'); document.querySelector('.nav-bar').style.display='none'; }
        function cancelSession(){ if(confirm("Annuler ?")){ document.querySelector('.nav-bar').style.display='flex'; switchView('view-history'); } }
        function addSetToBuffer(){ const v1=document.getElementById('inputVal1').value; const v2=document.getElementById('inputVal2').value; if(!v2)return; bufferSets.push({val1:parseFloat(v1||0), val2:parseFloat(v2), mode:currentMode}); let h=''; bufferSets.forEach((s,i)=>{ h+=`<div>S√©rie ${i+1}: ${s.mode==='time'?s.val2+'s':s.val2+' reps'} ${s.val1>0?'@ '+s.val1+'kg':''}</div>`; }); document.getElementById('bufferList').innerHTML=h; }
        function confirmExercise(){ const n=document.getElementById('exoName').value; if(!n||bufferSets.length===0)return; saveToLibrary(n,currentCategory); currentSession.exercises.push({name:n, category:currentCategory, type:bufferSets[0].mode, sets:[...bufferSets]}); document.getElementById('currentSessionList').innerHTML+=`<div class="card" style="padding:10px; border-left:4px solid var(--primary);"><strong>${n}</strong><br><small>${bufferSets.length} s√©ries</small></div>`; bufferSets=[]; document.getElementById('bufferList').innerHTML='...'; document.getElementById('exoName').value=''; document.getElementById('inputVal1').value=''; document.getElementById('inputVal2').value=''; }
        function finishSession(){ if(currentSession.exercises.length===0)return; const db=JSON.parse(localStorage.getItem(DB_KEY)||'[]'); db.push(currentSession); localStorage.setItem(DB_KEY,JSON.stringify(db)); document.querySelector('.nav-bar').style.display='flex'; switchView('view-history'); }
        function renderHistory(){ const db=JSON.parse(localStorage.getItem(DB_KEY)||'[]'); db.sort((a,b)=>new Date(b.date)-new Date(a.date)); const l=document.getElementById('historyList'); l.innerHTML=''; db.forEach(s=>{ const d=new Date(s.date).toLocaleDateString(); l.innerHTML+=`<div class="history-item"><div><strong>${d}</strong><br><small>${s.exercises.length} exos</small></div><div class="pr-badge">${s.userWeight}kg</div></div>`; }); }
        
        function initRadar(){ const db=JSON.parse(localStorage.getItem(DB_KEY)||'[]'); let st={'Push':0,'Pull':0,'Legs':0,'Core':0}; db.forEach(s=>s.exercises.forEach(e=>{ const c=e.category||'Push'; if(st[c]!==undefined) st[c]+=e.sets.length; })); const ctx=document.getElementById('radarChart').getContext('2d'); if(radarChart)radarChart.destroy(); radarChart=new Chart(ctx,{type:'radar',data:{labels:['Pouss√©e','Tirage','Jambes','Core'],datasets:[{label:'Vol',data:[st.Push,st.Pull,st.Legs,st.Core],backgroundColor:'rgba(79,70,229,0.2)',borderColor:'#4F46E5'}]},options:{scales:{r:{suggestMin:0,ticks:{display:false}}},plugins:{legend:{display:false}}}}); }
        function initStats(){ const db=JSON.parse(localStorage.getItem(DB_KEY)||'[]'); const s=document.getElementById('statExoSelect'); const u=new Set(); db.forEach(x=>x.exercises.forEach(e=>u.add(e.name))); s.innerHTML=''; u.forEach(n=>s.add(new Option(n,n))); if(u.size>0)updateLineChart(); }

        // EMOM & TIMER (Same as V10)
        function toggleCreateForm(){ const e=document.getElementById('emom-create'); e.style.display=e.style.display==='none'?'block':'none'; }
        function getEmomData(){ return JSON.parse(localStorage.getItem(EMOM_KEY)||'{"active":[],"archives":[]}'); }
        function saveEmomData(d){ localStorage.setItem(EMOM_KEY,JSON.stringify(d)); }
        function createEmomCycle(){ const n=document.getElementById('newCycleExo').value; const l=document.getElementById('newCycleLoad').value||'Std'; const r=parseInt(document.getElementById('newCycleReps').value); if(!n||!r)return; const w=[{id:1,d:10,r:r,l:'Base'},{id:2,d:12,r:r,l:'Vol+'},{id:3,d:15,r:r,l:'Max'},{id:4,d:10,r:r+1,l:'Dens'},{id:5,d:12,r:r+1,l:'Peak'},{id:6,d:10,r:Math.ceil(r/2),l:'Deload'}]; const d=getEmomData(); d.active.push({id:Date.now(),exo:n,load:l,base:r,start:new Date().toISOString(),weeks:w}); saveEmomData(d); toggleCreateForm(); renderEmomView(); }
        function renderEmomView(){ const d=getEmomData(); activeCycles=d.active; const al=document.getElementById('activeCyclesList'); al.innerHTML=''; activeCycles.forEach(c=>{ let h=''; c.weeks.forEach((w,i)=>{ const dn=w.done?'opacity:0.5;text-decoration:line-through':''; const ac=(!w.done&&(i===0||c.weeks[i-1].done))?'background:var(--primary-light);color:var(--primary);font-weight:bold':''; const b=(!w.done&&(i===0||c.weeks[i-1].done))?`<button class="btn-primary" style="padding:4px 8px;width:auto;margin:0;font-size:0.8em" onclick="openTimer(${c.id},${i})">GO</button>`:(w.done?'‚úÖ':'üîí'); h+=`<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #f0f0f0;${dn};${ac}">${w.id}. ${w.d}'√ó${w.r} ${b}</div>`; }); al.innerHTML+=`<div class="card" style="border-left:5px solid var(--secondary);padding:10px;"><strong>${c.exo}</strong> (${c.load}) <button class="btn-danger" style="float:right;width:auto;padding:2px 8px;margin:0;font-size:0.7em" onclick="deleteCycle(${c.id})">X</button>${h}</div>`; }); const ar=document.getElementById('emom-archives'); ar.innerHTML=''; d.archives.forEach(c=>{ ar.innerHTML+=`<div style="padding:5px;border-bottom:1px solid #eee">‚úÖ ${c.exo}</div>`; }); }
        function deleteCycle(id){ if(confirm("Suppr?")){ const d=getEmomData(); d.active=d.active.filter(c=>c.id!==id); saveEmomData(d); renderEmomView(); } }
        function toggleArchives(){ const e=document.getElementById('emom-archives'); e.style.display=e.style.display==='none'?'block':'none'; }
        
        function openTimer(cid,wid){ runningCycleId=cid; runningWeekIndex=wid; const c=activeCycles.find(x=>x.id===cid); const w=c.weeks[wid]; totalRounds=w.d; currentRound=1; timerSeconds=0; document.getElementById('timerExoTitle').innerText=c.exo; document.getElementById('timerLoadInfo').innerText=`${c.load} ‚Ä¢ ${w.r} reps`; document.getElementById('timer-overlay').style.display='flex'; document.getElementById('btnGo').style.display='block'; document.getElementById('btnStop').style.display='none'; }
        function closeTimer(){ clearInterval(timerInterval); document.getElementById('timer-overlay').style.display='none'; }
        function startTimerEngine(){ if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)(); document.getElementById('btnGo').style.display='none'; document.getElementById('btnStop').style.display='block'; playBeep(880,0.3); timerInterval=setInterval(tick,1000); }
        function stopTimerEngine(){ clearInterval(timerInterval); if(confirm("Valider?")){ const d=getEmomData(); const idx=d.active.findIndex(x=>x.id===runningCycleId); d.active[idx].weeks[runningWeekIndex].done=true; if(runningWeekIndex===5){ alert("Fini!"); d.archives.push(d.active[idx]); d.active.splice(idx,1); } saveEmomData(d); renderEmomView(); document.getElementById('timer-overlay').style.display='none'; } else { document.getElementById('btnGo').style.display='block'; document.getElementById('btnStop').style.display='none'; } }
        function tick(){ timerSeconds++; const l=60-timerSeconds; if(l===30)playBeep(300,0.2,'triangle'); if(l===10){playBeep(600,0.1);setTimeout(()=>playBeep(600,0.1),200);} if(timerSeconds>=60){ timerSeconds=0; currentRound++; if(currentRound>totalRounds){playBeep(880,0.5);stopTimerEngine();return;} playBeep(880,0.3); } document.getElementById('timerBigDisplay').innerText=l<10?`00:0${l}`:`00:${l}`; document.getElementById('timerRoundDisplay').innerText=`${currentRound}/${totalRounds}`; }
        function playBeep(f,d,t='sine'){ if(!audioCtx)return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type=t; o.frequency.value=f; o.start(); g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+d); o.stop(audioCtx.currentTime+d); }

    </script>
</body>
</html>
