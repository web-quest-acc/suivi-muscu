<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muscu App V3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2196F3; --success: #4CAF50; --bg: #f4f4f9; }
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 15px; background-color: var(--bg); padding-bottom: 80px;}
        
        /* Navigation en bas */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 15px 0; z-index: 100; }
        .nav-item { cursor: pointer; color: #666; font-weight: bold; text-align: center; flex: 1; }
        .nav-item.active { color: var(--primary); }

        /* Vues (Pages) */
        .view { display: none; }
        .view.active { display: block; }

        /* Composants */
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2, h3 { margin-top: 0; color: #333; }
        
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; color: white; margin-top: 10px;}
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: #f44336; }
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }

        /* Liste des s√©ries en cours */
        .set-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
        .session-item { border-left: 4px solid var(--primary); padding-left: 10px; margin-bottom: 10px; }
        
        /* Toggle Temps/Reps */
        .mode-toggle { display: flex; gap: 10px; margin-bottom: 10px; }
        .mode-btn { flex: 1; padding: 8px; text-align: center; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        .mode-btn.selected { background-color: var(--primary); color: white; border-color: var(--primary); }

        .chart-container { position: relative; height: 250px; width: 100%; }
        .summary-detail { font-size: 0.9em; color: #555; margin-left: 15px; }
    </style>
</head>
<body>

    <div id="view-history" class="view active">
        <h2>üìÖ Mes Sessions</h2>
        <div id="historyList"></div>
        <div style="height: 50px;"></div> <button class="btn-success" onclick="startNewSession()" style="position:fixed; bottom: 70px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 550px; shadow: 0 4px 10px rgba(0,0,0,0.2);">
            + Commencer une s√©ance
        </button>
    </div>

    <div id="view-workout" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>üî• S√©ance en cours</h2>
            <button class="btn-danger" style="width:auto; padding: 5px 10px; margin:0;" onclick="cancelSession()">X</button>
        </div>
        
        <div class="card">
            <h3>Ajouter un exercice</h3>
            <input type="text" id="exoName" list="exoSuggestions" placeholder="Nom (ex: Squat, Planche...)">
            <datalist id="exoSuggestions"></datalist>

            <div class="mode-toggle">
                <div class="mode-btn selected" id="modeReps" onclick="setMode('reps')">R√©p√©titions</div>
                <div class="mode-btn" id="modeTime" onclick="setMode('time')">Temps (Chrono)</div>
            </div>

            <div style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <label id="labelVal1">Poids (kg)</label>
                    <input type="number" id="inputVal1" placeholder="80">
                </div>
                <div style="flex:1">
                    <label id="labelVal2">R√©p√©titions</label>
                    <input type="number" id="inputVal2" placeholder="10">
                </div>
            </div>

            <button class="btn-outline" onclick="addSetToBuffer()">Ajouter la s√©rie</button>

            <div id="bufferList" style="margin-top: 15px; background: #f9f9f9; padding: 10px; border-radius: 4px;">
                <em>Aucune s√©rie ajout√©e pour cet exercice...</em>
            </div>

            <button class="btn-primary" onclick="confirmExercise()">Valider l'exercice</button>
        </div>

        <h3>D√©j√† fait aujourd'hui :</h3>
        <div id="currentSessionList"></div>

        <button class="btn-success" onclick="finishSession()">Terminer et Sauvegarder la s√©ance</button>
    </div>

    <div id="view-stats" class="view">
        <h2>üìà Ma Progression</h2>
        <div class="card">
            <label>Choisir un exercice</label>
            <select id="statExoSelect" onchange="updateChart()"></select>
            <div class="chart-container">
                <canvas id="progChart"></canvas>
            </div>
            <p style="font-size: 0.8em; color: #666; text-align: center; margin-top: 10px;">
                *Pour le graphique, on prend la meilleure perf (Max Poids ou Max Temps) de chaque s√©ance.
            </p>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchView('view-history', this)">Sessions</div>
        <div class="nav-item" onclick="switchView('view-stats', this)">Stats</div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DB_KEY = 'muscu_app_v3';
        let currentSession = { date: null, exercises: [] };
        let bufferSets = []; // S√©ries en attente de validation pour l'exercice en cours
        let currentMode = 'reps'; // 'reps' ou 'time'
        let myChart = null;

        // --- GESTION DES VUES ---
        function switchView(viewId, navElement) {
            // Masquer toutes les vues
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            // Afficher la vue demand√©e
            document.getElementById(viewId).classList.add('active');
            
            // G√©rer la nav active
            if(navElement) {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                navElement.classList.add('active');
            }

            if(viewId === 'view-history') renderHistory();
            if(viewId === 'view-stats') initStats();
        }

        // --- LOGIQUE S√âANCE ---
        function startNewSession() {
            currentSession = { 
                date: new Date().toISOString(), 
                exercises: [] 
            };
            bufferSets = [];
            renderBuffer();
            renderCurrentSession();
            
            // Reset des champs
            document.getElementById('exoName').value = '';
            document.getElementById('inputVal1').value = '';
            document.getElementById('inputVal2').value = '';

            // Afficher la vue Workout
            switchView('view-workout');
            // Cacher la navbar pendant la s√©ance pour √©viter de quitter par erreur
            document.querySelector('.nav-bar').style.display = 'none';
        }

        function cancelSession() {
            if(confirm("Annuler la s√©ance en cours ? Tout sera perdu.")) {
                document.querySelector('.nav-bar').style.display = 'flex';
                switchView('view-history');
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('modeReps').className = mode === 'reps' ? 'mode-btn selected' : 'mode-btn';
            document.getElementById('modeTime').className = mode === 'time' ? 'mode-btn selected' : 'mode-btn';

            if(mode === 'reps') {
                document.getElementById('labelVal1').innerText = "Poids (kg)";
                document.getElementById('labelVal2').innerText = "R√©p√©titions";
                document.getElementById('inputVal1').placeholder = "80";
            } else {
                document.getElementById('labelVal1').innerText = "Lest (kg) (Optionnel)";
                document.getElementById('labelVal2').innerText = "Temps (secondes)";
                document.getElementById('inputVal1').placeholder = "0";
            }
        }

        function addSetToBuffer() {
            const val1 = document.getElementById('inputVal1').value; // Poids
            const val2 = document.getElementById('inputVal2').value; // Reps ou Temps

            if(!val2) { alert("Il faut au moins des reps ou du temps !"); return; }

            bufferSets.push({
                val1: val1 || 0, // Poids (peut √™tre 0)
                val2: val2,      // Reps ou Temps
                mode: currentMode
            });

            renderBuffer();
        }

        function renderBuffer() {
            const container = document.getElementById('bufferList');
            if (bufferSets.length === 0) {
                container.innerHTML = '<em>Aucune s√©rie ajout√©e...</em>';
                return;
            }
            let html = '<ul>';
            bufferSets.forEach((set, index) => {
                const unit = set.mode === 'reps' ? 'reps' : 'sec';
                html += `<li>S√©rie ${index+1}: <strong>${set.val2} ${unit}</strong> @ ${set.val1}kg</li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        function confirmExercise() {
            const name = document.getElementById('exoName').value;
            if(!name || bufferSets.length === 0) {
                alert("Nom d'exercice manquant ou aucune s√©rie ajout√©e.");
                return;
            }

            // Ajouter l'exercice complet √† la session
            currentSession.exercises.push({
                name: name.charAt(0).toUpperCase() + name.slice(1),
                sets: [...bufferSets] // Copie du tableau
            });

            // Reset pour le prochain exo
            bufferSets = [];
            document.getElementById('exoName').value = '';
            document.getElementById('inputVal1').value = '';
            document.getElementById('inputVal2').value = '';
            renderBuffer();
            renderCurrentSession();
        }

        function renderCurrentSession() {
            const container = document.getElementById('currentSessionList');
            let html = '';
            currentSession.exercises.forEach((exo, idx) => {
                // Cr√©er une string type "10/10/8"
                const setsSummary = exo.sets.map(s => s.val2).join(' / ');
                const maxWeight = Math.max(...exo.sets.map(s => parseFloat(s.val1)));
                
                html += `<div class="session-item">
                            <strong>${exo.name}</strong><br>
                            <small>${exo.sets.length} s√©ries : ${setsSummary} (${exo.sets[0].mode === 'reps' ? 'Max '+maxWeight+'kg' : 'Temps'})</small>
                         </div>`;
            });
            container.innerHTML = html;
        }

        function finishSession() {
            if(currentSession.exercises.length === 0) {
                alert("La s√©ance est vide !");
                return;
            }
            
            // Sauvegarde en DB
            const db = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            db.push(currentSession);
            localStorage.setItem(DB_KEY, JSON.stringify(db));

            alert("S√©ance sauvegard√©e ! Bravo üí™");
            document.querySelector('.nav-bar').style.display = 'flex';
            switchView('view-history');
        }

        // --- HISTORIQUE & STATS ---
        function renderHistory() {
            const db = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            const container = document.getElementById('historyList');
            
            // Trier par date d√©croissante (plus r√©cent en haut)
            db.sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = '';
            db.forEach(session => {
                const dateObj = new Date(session.date);
                const dateStr = dateObj.toLocaleDateString('fr-FR') + ' √† ' + dateObj.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
                
                let details = '';
                session.exercises.forEach(exo => {
                    const setsStr = exo.sets.map(s => s.val2).join('/');
                    const unit = exo.sets[0]?.mode === 'reps' ? 'reps' : 'sec';
                    // On affiche le poids de la premi√®re s√©rie pour info
                    const weightInfo = exo.sets[0]?.val1 > 0 ? `@ ${exo.sets[0].val1}kg` : '';
                    details += `<div class="summary-detail">‚Ä¢ ${exo.name}: ${setsStr} ${unit} ${weightInfo}</div>`;
                });

                html += `<div class="card">
                            <h3 style="margin-bottom:5px;">S√©ance du ${dateStr}</h3>
                            ${details}
                         </div>`;
            });
            container.innerHTML = html || '<p style="text-align:center">Aucune s√©ance enregistr√©e.</p>';
        }

        function initStats() {
            const db = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            const select = document.getElementById('statExoSelect');
            const uniqueExos = new Set();
            
            db.forEach(s => s.exercises.forEach(e => uniqueExos.add(e.name)));
            
            select.innerHTML = '';
            uniqueExos.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.innerText = name;
                select.appendChild(opt);
            });
            
            if(uniqueExos.size > 0) updateChart();
        }

        function updateChart() {
            const exoName = document.getElementById('statExoSelect').value;
            const db = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            
            // On extrait les donn√©es pour cet exo
            // On prend la date de la s√©ance, et la MEILLEURE perf de la s√©ance (Max Poids ou Max Temps)
            const dataPoints = [];
            const labels = [];

            // Trier du plus vieux au plus r√©cent pour le graph
            db.sort((a, b) => new Date(a.date) - new Date(b.date));

            db.forEach(session => {
                const sessionDate = new Date(session.date).toLocaleDateString('fr-FR');
                
                // Chercher si l'exercice a √©t√© fait dans cette session
                const exercises = session.exercises.filter(e => e.name === exoName);
                
                exercises.forEach(e => {
                    // Trouver la meilleure perf de la session
                    // Si c'est Reps : on prend le Poids Max
                    // Si c'est Temps : on prend le Temps Max
                    let maxVal = 0;
                    e.sets.forEach(s => {
                        const valToCheck = s.mode === 'reps' ? parseFloat(s.val1) : parseFloat(s.val2);
                        if(valToCheck > maxVal) maxVal = valToCheck;
                    });

                    labels.push(sessionDate);
                    dataPoints.push(maxVal);
                });
            });

            const ctx = document.getElementById('progChart').getContext('2d');
            if(myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Meilleure Perf (Kg ou Sec)',
                        data: dataPoints,
                        borderColor: '#2196F3',
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(33, 150, 243, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        
        // Init au chargement
        renderHistory();
    </script>
</body>
</html>
